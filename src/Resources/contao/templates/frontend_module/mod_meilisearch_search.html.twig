{#
Meilisearch Frontend Search
Contao 5 – Frontend Module Template
#}
<!-- indexer::stop -->
<div
        id="topsearch"
        class="meilisearch-search"
        data-limit="{{ meiliLimit }}"
>
    <div class="headersearch">
        <form id="search-form" onsubmit="return false;">
            <div class="formbody">
                <div class="widget widget-text">
                    <label for="search_input" class="invisible">
                        {{ 'Suchen'|trans }}
                    </label>

                    <div class="search-field">
                        <input
                                type="search"
                                name="keywords"
                                id="search_input"
                                class="text"
                                placeholder="Suchbegriff eingeben..."
                                autocomplete="off"
                        >

                        <button
                                type="button"
                                class="clear-button"
                                aria-label="Suche löschen"
                                hidden
                        >
                            ×
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <div id="search-results"></div>

        <template id="search-result-template">
            <div class="search-item">
                <div class="siteimage"></div>

                <div class="teaser">
                    <div class="title"></div>
                    <div class="extract"></div>
                    <div class="pfad"></div>
                </div>

                <a class="masterurl" href="#" title=""></a>
            </div>
        </template>
    </div>
</div>

<script type="module">
    import MeiliSearch from 'https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.esm.js';

    document.addEventListener('DOMContentLoaded', () => {

        const wrapper = document.querySelector('.meilisearch-search');
        if (!wrapper) {
            return;
        }

        const input   = wrapper.querySelector('#search_input');
        const clear   = wrapper.querySelector('.meilisearch-clear');
        const results = wrapper.querySelector('#search-results');
        const template = wrapper.querySelector('#search-result-template');

        if (!input || !results || !template) {
            console.warn('[Meilisearch] Required elements not found');
            return;
        }

        const limit = parseInt(wrapper.dataset.limit, 10) || 50;

        const client = new MeiliSearch({
            host: '{{ meiliHost }}',
            apiKey: '{{ meiliSearchKey }}'
        });

        const index = client.index('{{ meiliIndex }}');

        let abortController = null;

        // ----------------------------
        // Clear button
        // ----------------------------
        clear.addEventListener('click', () => {
            input.value = '';
            results.innerHTML = '';
            clear.hidden = true;
            input.focus();
        });

        // ----------------------------
        // Input handling
        // ----------------------------
        input.addEventListener('input', async () => {

            const query = input.value.trim();
            clear.hidden = query.length === 0;

            if (query.length < 2) {
                results.innerHTML = '';
                return;
            }

            abortController?.abort();
            abortController = new AbortController();

            try {
                const response = await index.search(query, {
                    limit: limit,

                    attributesToRetrieve: [
                        'title',
                        'url',
                        'text',
                        'poster',
                        'priority'
                    ],

                    attributesToHighlight: ['text'],
                    attributesToCrop: ['text'],
                    cropLength: 50,
                    cropMarker: '…',

                    sort: ['startDate:asc', 'priority:desc']
                });

                renderResults(response.hits);

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('[Meilisearch]', e);
                }
            }
        });

        // ----------------------------
        // Render results via <template>
        // ----------------------------
        function renderResults(hits) {

            results.innerHTML = '';

            if (!hits || !hits.length) {
                return;
            }

            for (const hit of hits) {

                const node = template.content.cloneNode(true);

                const image   = node.querySelector('.siteimage');
                const title   = node.querySelector('.title');
                const extract = node.querySelector('.extract');
                const path    = node.querySelector('.pfad');
                const link    = node.querySelector('.masterurl');

                // Title
                title.textContent = hit.title || '';

                // Link
                link.href = hit.url || '#';
                link.title = hit.title || '';

                // Extract / highlight
                if (hit._formatted?.text) {
                    extract.innerHTML = hit._formatted.text;
                } else {
                    extract.textContent = '';
                }

                // Path (URL ohne Schema)
                if (hit.url) {
                    path.textContent = hit.url.replace(/^https?:\/\//, '');
                }

                // Image
                if (hit.poster) {
                    image.style.backgroundImage = `url(${hit.poster})`;
                } else {
                    image.style.backgroundImage = '';
                }

                results.appendChild(node);
            }
        }
    });
</script>
<!-- indexer::continue -->